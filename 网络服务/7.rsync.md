# rsync

简介：

- remote synchronize 远程同步。
- 远程同步工具，常用作数据远程备份、同步，也可以实现本地复制。
- 同步时采用 rsync 算法，性能较高。
- 通过 md5sum 获取文件特征码的方式区分文件变化。
- 可以实现完全同步，也可以增量同步。
- 能更新整个目录树和文件系统。
- 再同步时可以有选择性的保留文件的各种信息属性，如符号连接、硬链接、文件属性、权限、设备、时间等。
- 对多个文件来说，文件传输效率高。

与 scp 区别：

- 是多线程工具，相比 scp 的单线程，传输速度快。
- 支持增量传递，相比 scp 全部替换，同步效率更高。

原理：

- 可用作例行定时备份工具。
- 同步是单向的，由基准服务器作为源数据来源(上传)，由备份服务器作为目标数据接收者(下载)。
- 需要恢复备份时则反过来。
- 登录验证方式有 ssh 和 rsync

## rsync 命令

> `-a` archive 归档模式，递归并保留文件所有属性信息。  
> `-v` vebose 显示同步过程。  
> `-z` compress 在传输文件时进行压缩。  
> `--delete` 强同步，会删除目标目录相比源目录不存在的文件，即目标目录内容与源目录完全一致。

数据的同步方式有 **推送(上传)** 和 **拉取(下载)** 两种方式。

基于 SSH 协议的数据备份(基准服务器->备份服务器)：

- 基准服务器推送给备份服务器：`rsync -avz 本地基准目录 用户名@备份服务器地址:备份目录`
- 备份服务器从基准服务器拉取：`rsync -avz 用户名@基准服务器地址:基准目录 本地备份目录`

> 此处的目录有 `dir` 与 `dir/` 之分。  
> `dir` 则表示包含此目录与此目录下所有文件。  
> `dir/` 则表示仅包含此目录下所有文件，此目录则不包含在内。

基于 SSH 协议的数据恢复(备份服务器->基准服务器)：

- 备份服务器推送给基准服务器：`rsync -avz 本地备份目录 用户名@基准服务器地址:基准目录`
- 基准服务器从备份服务器拉取：`rsync -avz 用户名@备份服务器地址:备份目录 本地基准目录`

SSH 登录验证模式可以使用密钥进行免密登录：

1. `ssh-keygen -t rsa -b 2048`
2. `ssh-copy-id 用户名@要免密登录的远程IP`

可以使用专门的用户管理 rsync 的同步目录，设置其为所有者或者增加 ACL 权限。

## rsync+inotify 实现单向实时同步

拿到 inotify 源码包进行生成、编译、安装

inotify 用于监控文件系统的各种事件(event)变化。

有 `inotifywait` 和 `inotifywatch` 命令，主要使用 `inotifywait` 命令进行持续监控。

`inotifywait -mrq -e <监听动作1,监听动作2> 监听目录`

> `-m` 始终保持事件监听状态。  
> `-r` 递归查询目录。  
> `-q` 只打印监控事件的信息(不打印如建立监听进程的提示信息等多余内容)。  
> `-e` 只监听指定的事件，常用有{`create,delete,modify,attrib`}。

通过脚本实现通过 inotify 监听，实时进行 rsync 同步：

```bash
#!/bin/bash

event1="inotifywait -mrq -e create,delete,modify /base.d"

action="rsync -avz --delete /base.d/ root@192.168.233.73:/rsync.d"

${event1} | while read directory event file
do
    $action &> /dev/null
done

#while read为一种固定用法，通过read逐行读取管道符前的内容，即event1所表示的命令的输出，将其每行读入directory event file三个变量，read向while返回值为0(即真值)，所以进行一次循环操作，而且inotifywait为持续进程，管道符后面的while需要持续等待前面传来的内容，所以能一直保持循环。
```

将此脚本赋予执行权限并使用&后缀放入后台运行，实现实时监听，注意配置两台同步设备的免密登录。
