# 数据备份与恢复

## 备份的内容和方式

1. **Linux 服务器中哪些数据需要备份**
   1. Linux 系统重要数据  
      `/root/`目录：管理员家目录  
      `/home/`目录：生产环境的服务器，此目录会保存大量重要数据  
      `/etc/`目录：系统重要的配置文件保存目录
   2. 安装服务的数据，例：Apache
      - 配置文件：  
        RPM 包 `/etc/httpd/conf/httpd.conf`  
        源码包 `/usr/local/apache2/conf/httpd.conf`
      - 网页主目录：  
        RPM 包 `/var/www/html/`  
        源码包 `/usr/local/apache2/htdocs/`
      - 日志文件：  
        RPM 包 `/var/log/httpd/`  
        源码包 `/usr/local/apache2/logs/`
        > 需要对 RPM 包与源码包的安装位置和目录结构不相同有概念
2. **备份策略**
   1. 完全备份
      - 每次都把所有需要备份的数据全部备份
      - 恢复数据方便，但备份数据量大，备份时间较长，占用空间多
      - 一般对关键服务器进行完全备份，以便出问题能及时替换
   2. 增量备份
      - 先进行一次完全备份，之后每次备份时和之前的总备份数据作比较，只备份有差异的数据
      - 备份数据量较少，耗时较少，占用空间较少，数据恢复需要按照先备份先恢复的顺序逐步恢复，恢复比较麻烦。
   3. 差异备份
      - 先进行一次完全备份，之后每次备份时都和第一次完全备份的原始数据作比较，只备份有差异的数据（即之后每次备份都类似第一次增量备份）
      - 备份时不需要每次都备份所有数据，恢复时也不需要逐次按顺序恢复（先恢复原始，再恢复差异即可）
      - 但随着时间的增加，差异的数据越来越多，备份数据也会越来越庞大，导致备份缓慢，占用空间大

| 备份策略 | 备份 1 | 备份 2              | 备份 3                     | 备份 4                            | ... |
| -------- | ------ | ------------------- | -------------------------- | --------------------------------- | --- |
| 完全     | 完全 1 | 完全 2              | 完全 3                     | 完全 4                            | ... |
| 增量     | 完全 1 | 当前与完全 1 的差异 | 当前与完全 1+备份 2 的差异 | 当前与完全 1+备份 2+备份 3 的差异 | ... |
| 差异     | 完全 1 | 当前与完全 1 的差异 | 当前与完全 1 的差异        | 当前与完全 1 的差异               | ... |

## `dd`命令

`dd if=输入文件 of=输出文件` 从输入文件完全复制所有信息到输出文件

> 分区表、文件系统、uuid 等所有内容都会完全复制  
> 可以实现
>
> - 分区-->文件
> - 分区-->硬盘
> - 硬盘-->硬盘
>
> 反之亦然

解决 dd 的文件/分区 uuid 相同无法挂载的问题： `mount -o nouuid 设备文件/文件 挂载点`

## XFS 文件系统的备份与恢复

_使用`xfsdump`命令备份，`xfsrestore`命令恢复_

**`xfsdump [选项] xfs文件系统`**

> `-L <名称>` 指定本次备份的说明标签  
> `-M <名称>` 指定本次备份的设备的说明标签  
> `-l <0-9>` 指定备份级别，0 是完整备份，1-9 是增量备份
>
> > - 增量备份：0,1,2,3,4,...9,0,1,2...
> > - 差异备份：0,1,1,1,1...
>
> `-f <文件路径>` 指定备份生成的文件  
> `-I` 列出本文件系统的备份状态记录  
> `-s <文件或目录，相对本文件系统的路径>` 只对指定的文件或目录进行备份

- xfs 文件系统可以指定为设备文件或目录，如果指定为目录，则后面不能带`/`
- 备份成功后，可以在`/var/lib/xfsdump/inventory`目录下看到生成的档案信息

> `xfsdump`使用注意事项：
>
> - `xfsdump`不支持对没有挂载的文件系统进行备份，需要备份请挂载之后备份。
> - `xfsdump`必须使用 root 身份才能够有权限执行。
> - `xfsdump`只能备份 xfs 文件系统。
> - `xfsdump`备份过的数据只能被`xfsrestore`解析。
> - `xfsdump`默认只支持备份文件系统，并不支持特定某个目录的备份。
> - `xfsdump`是通过文件系统的 UUID 来辨别各个备份文件，因此不能备份两个具有相同 UUID 的文件系统。
>
> **`xfsrestore -f <备份文件> 恢复到的路径`** 恢复`xfsdump`的备份

## `scp`命令

`scp 本地源文件 远程用户名@远程ip地址:远程路径` 上传  
`scp 远程用户名@远程ip地址:远程源文件 本地路径` 下载
